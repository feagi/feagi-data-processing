name: Main PR Tests

on:
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  comprehensive-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout PR code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Checkout base branch
      run: git fetch origin main:main
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
    
    - name: Install additional Rust components
      run: |
        rustup component add clippy rustfmt
    
    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
    
    - name: Check code formatting
      run: cargo fmt --all -- --check
    
    - name: Run Clippy (linting)
      run: cargo clippy --all-targets --all-features -- -D warnings
    
    - name: Run all tests
      run: cargo test --verbose --all-features
    
    - name: Run tests in release mode
      run: cargo test --release --verbose
    
    - name: Check documentation
      run: cargo doc --no-deps --document-private-items
    
    - name: Build in release mode
      run: cargo build --release --verbose
    
    - name: Check version number increase
      run: |
        # Get current version from PR
        CURRENT_VERSION=$(grep '^version = ' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
        echo "Current version: $CURRENT_VERSION"
        
        # Get version from main branch
        git checkout main -- Cargo.toml
        MAIN_VERSION=$(grep '^version = ' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
        echo "Main version: $MAIN_VERSION"
        
        # Restore PR version
        git checkout HEAD -- Cargo.toml
        
        # Compare versions using sort -V (version sort)
        if [ "$CURRENT_VERSION" = "$MAIN_VERSION" ]; then
          echo "❌ Error: Version must be increased from main branch"
          echo "Current: $CURRENT_VERSION, Main: $MAIN_VERSION"
          exit 1
        fi
        
        # Check if current version is greater than main version
        HIGHER_VERSION=$(printf '%s\n%s\n' "$MAIN_VERSION" "$CURRENT_VERSION" | sort -V | tail -n1)
        if [ "$HIGHER_VERSION" != "$CURRENT_VERSION" ]; then
          echo "❌ Error: Version must be higher than main branch"
          echo "Current: $CURRENT_VERSION, Main: $MAIN_VERSION"
          exit 1
        fi
        
        echo "✅ Version check passed: $MAIN_VERSION → $CURRENT_VERSION"
    
    - name: Validate version format
      run: |
        VERSION=$(grep '^version = ' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
        if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
          echo "❌ Error: Version must be in format X.Y.Z or X.Y.Z-suffix"
          exit 1
        fi
        echo "✅ Version format is valid: $VERSION"
    
    - name: Check package can be published
      run: cargo package --verbose
    
    - name: Dry run publish to crates.io
      run: |
        echo "Performing dry run publish to crates.io..."
        cargo publish --dry-run --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        echo "✅ Dry run publish successful" 